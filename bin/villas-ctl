#!/usr/bin/env python

import logging
import argparse
import kombu

from villas.controller.config import Config, ConfigType
from villas.controller.command import Command

LOGGER = logging.getLogger(__name__)

def setup_logging():
	logging.basicConfig(level=logging.DEBUG,
		format='%(asctime)s %(levelname)-8s %(name)s %(message)s',
		datefmt='%Y-%m-%d %H:%M:%S'
	)

	amqp = logging.getLogger('amqp')
	amqp.setLevel(logging.INFO)

	LOGGER.setLevel(logging.DEBUG)

def setup_argparse():
	# Main parser
	parser = argparse.ArgumentParser(
		prog = 'villas-ctl'
	)

	parser.add_argument('-b', '--broker',
		help = 'URL of AMQP broker',
		default = "amqp://guest:guest@localhost/%2F"
	)

	parser.add_argument('-c', '--config',
		help = 'Path of configuration file',
		type = ConfigType(),
		default = Config()
	)

	# Add parsers for subcommands
	Command.register_subcommands(parser)

	return parser

if __name__ == '__main__':
	setup_logging()
	parser = setup_argparse()

	args = parser.parse_args()

	with kombu.Connection(args.broker) as c:
		try:
			args.func(c, args)
		except KeyboardInterrupt:
			LOGGER.info("Ctrl-C... Abort")
